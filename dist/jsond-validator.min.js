!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):t["jsond-validator"]=r()}(this,function(){"use strict";function t(t){this.src=[],this.data=[],this.path=[],this.vars={},this.start(t)}function r(t,r){for(var e=t;"string"==typeof e&&r[e];)e=r[e];return e}function e(t,i){var o,a=r(t,i);return Array.isArray(a)?o=a.map(function(t){return e(t,i)}):n(a)?(o={},Object.keys(a).forEach(function(t){o[t]=e(a[t],i)})):o=a,o}function n(t){return null!=t&&"object"==typeof t&&!Array.isArray(t)&&t.constructor===Object}function i(){this.schemas={},this.compiled={}}var o=function(t){t.add("return E")},a=function(t,r){if(Array.isArray(r)){var e=t.var("i");t.add("if(!Array.isArray(%s))"),t.error("ARRAY_REQUIRED"),t.add("else"),t.add("for(var %p=0;%p<%s.length;%p++){",e,e,e),r.length&&(t.stack(e,e),t.visit(r[0]),t.pop()),t.add("}")}},s="\\-?(?:0|[1-9]\\d*)(?:\\.\\d+)?",f={boolean:"boolean",integer:"integer",interval:new RegExp("^(\\[|\\()("+s+")?,("+s+")?(\\]|\\))$"),number:"number",optional:/\?$/,set:new RegExp("^{("+s+"(,"+s+")*)}$"),string:"string"},d=function(t,r){r===f.boolean&&(t.add('if(typeof %s!=="boolean")'),t.error("BOOLEAN_REQUIRED"))},c=function(t,r){t.add("if(%s!==%p)",JSON.stringify(r)),t.error("CONSTANT")},p=function(t,r){r===f.integer&&(t.add('if(typeof %s!=="number"||%s<0||%s%1!==0)'),t.error("INTEGER_REQUIRED"))},u=function(t,r){r===f.number&&(t.add('if(typeof %s!=="number")'),t.error("NUMBER_REQUIRED"))},h=function(t,r){if("object"==typeof r){t.add('if(typeof %s!=="object")'),t.error("OBJECT_REQUIRED"),t.add("else {");for(var e={},n=Object.keys(r).map(function(t){var r=t.replace(f.optional,"");return e[r]=t===r,r}),i=0,o=n.length;i<o;i++){var a=n[i];e[a]?(t.add('if(!%s.hasOwnProperty("%p"))',a),t.error("OBJECT_PROPERTY_REQUIRED",JSON.stringify(a)),t.add("else {"),t.stack(JSON.stringify(a),"'"+a+"'"),t.visit(r[a]),t.pop(),t.add("}")):(t.add('if(%s.hasOwnProperty("%p"))',a),t.stack(JSON.stringify(a),"'"+a+"'"),t.visit(r[a+"?"]),t.pop())}var s=t.var("k"),d=t.var("i"),c=n.map(function(t){return s+"["+d+']!=="'+t+'"'}),p=n.length?c.join("&&"):"true";t.add("var %p=Object.keys(%s)",s),t.add("for(var %p=0;%p<%p.length;%p++){",d,d,s,d),t.add("if(%p)",p),t.error("OBJECT_PROPERTIES_ADDITIONAL",void 0,s+"["+d+"]"),t.add("}"),t.add("}")}},l=function(t,r,e){if("string"==typeof r){u(t,f.number);var n=e[2]&&e[2].length?Number(e[2]):null,i=e[3]&&e[3].length?Number(e[3]):null,o="["===e[1]?"<":"<=",a="]"===e[4]?">":">=";n&&(t.add("if(%s%p%p)",o,n),t.error("INTERVAL_START")),i&&(t.add("if(%s%p%p)",a,i),t.error("INTERVAL_END"))}},y=function(t,r,e){if("string"==typeof r){u(t,f.number);var n=e[1].split(",").map(function(t){return parseFloat(t)});t.add("if(%p.indexOf(%s)===-1)",JSON.stringify(n)),t.error("NOT_IN_SET")}},v=function(t,r){if("string"==typeof r){var e=r;"^"!==e[0]&&(e="^"+e),"$"!==e[e.length-1]&&(e+="$"),e=e.replace(/\//g,"\\/"),t.add('if(typeof %s!=="string")'),t.error("STRING_PATTERN"),t.add("else if(!/%p/.test(%s))",e),t.error("STRING_PATTERN")}},g=function(t,r){if("string"==typeof r){var e=r.match(f.set);(e?y:(e=r.match(f.interval))?l:v)(t,r,e)}},E=function(t,r){r===f.string&&(t.add('if(typeof %s!=="string")'),t.error("STRING_REQUIRED"))},m=function(t,r){(Array.isArray(r)?a:"object"==typeof r?h:r===f.boolean?d:r===f.number?u:r===f.integer?p:r===f.string?E:"string"==typeof r?g:c)(t,r)},R=function(t){t.add("var E=[]")},b=function(t,r,e,n){var i="["+e.join(",")+"]"+(n?".concat(["+n+"])":"");t.add("E.push({code:%p,path:%p})",JSON.stringify(r),i)},N="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};process.env.DEBUG&&(N._DEBUG_=!0),void 0===N._DEBUG_&&(N._DEBUG_=!1),t.prototype={generate:function(){var t=this.src.join("\n");return new Function("data",t)},start:function(t){R(this),this.stack(JSON.stringify("$"),"data"),this.visit(t),o(this)},stack:function(t,r){this.path.push(t),this.data.push("data"===r?r:"["+r+"]")},visit:function(t){m(this,t)},error:function(t,r,e){var n=[].concat(this.path).concat(void 0===r?[]:[r]);b(this,t,n,e)},var:function(t){return this.vars[t]||(this.vars[t]=0),this.vars[t]++,t+this.vars[t]},pop:function(){this.data.pop(),this.path.pop()},add:function(t){var r=this.data.join(""),e=Array.prototype.slice.call(arguments,1);this.src.push(t.replace(/%s/g,r).replace(/%p/g,function(){return e.shift()}))}},t.compile=function(r){return new t(r).generate()};var O=t;return i.prototype={addSchema:function(t,r){if(t===f.boolean||t===f.integer||t===f.number||t===f.string)throw new Error("Schema IDs should not match any JSOND types");return this.schemas[t]=r,this},getDereferencedSchema:function(t){return e(this.schemas[t],this.schemas)},validate:function(t,r){if(!this.schemas[r])return{valid:!1,errors:[{code:"NO_SCHEMA",path:["$"]}]};if(!this.compiled[r]){var n=e(this.schemas[r],this.schemas);this.compiled[r]=O.compile(n)}var i=this.compiled[r](t);return{valid:0===i.length,errors:i}}},i});
